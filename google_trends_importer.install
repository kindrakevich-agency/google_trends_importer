<?php

/**
 * @file
 * Install file for the Google Trends Importer module.
 */

/**
 * Implements hook_schema().
 */
function google_trends_importer_schema() {
  $schema = [];

  // Main table for trend items
  $schema['google_trends_data'] = [
    'description' => 'Stores daily Google Trends data.',
    'fields' => [
      'id' => [
        'type' => 'serial',
        'unsigned' => TRUE,
        'not null' => TRUE,
        'description' => 'Primary Key: Unique trend ID.',
      ],
      'title' => [
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'default' => '',
        'description' => 'The search term (trend title).',
      ],
      'traffic' => [
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
        'default' => 0,
        'description' => 'Approximate traffic in thousands (e.g., 100 for 100K+ searches).',
      ],
      'pub_date' => [
        'mysql_type' => 'DATETIME',
        'not null' => TRUE,
        'description' => 'The publication date of the trend.',
      ],
      'link' => [
        'type' => 'varchar',
        'length' => 2048,
        'not null' => TRUE,
        'default' => '',
        'description' => 'Link to the Google Trends page.',
      ],
      'snippet' => [
        'type' => 'text',
        'size' => 'normal',
        'not null' => FALSE,
        'description' => 'A snippet of news related to the trend.',
      ],
      'image_url' => [
        'type' => 'varchar',
        'length' => 2048,
        'not null' => FALSE,
        'description' => 'The main image URL from the RSS feed.',
      ],
      'processed' => [
        'type' => 'int',
        'size' => 'tiny',
        'unsigned' => TRUE,
        'not null' => TRUE,
        'default' => 0,
        'description' => 'Flag to mark as processed (0 = no, 1 = yes).',
      ],
      'node_id' => [
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => FALSE,
        'description' => 'The NID of the article created from this trend.',
      ],
      'imported_at' => [
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
        'default' => 0,
        'description' => 'Timestamp when the item was imported.',
      ],
      'processing_cost' => [
        'type' => 'numeric',
        'precision' => 10,
        'scale' => 6,
        'not null' => FALSE,
        'description' => 'Cost in USD for processing this trend with OpenAI.',
      ],
    ],
    'primary key' => ['id'],
    'unique keys' => [
      'title_date' => ['title', 'pub_date'],
    ],
    'indexes' => [
      'processed' => ['processed'],
      'title' => ['title'],
      'traffic' => ['traffic'],
    ],
  ];

  // Table for related news items
  $schema['google_trends_news_items'] = [
    'description' => 'Stores related news items for each Google Trend.',
    'fields' => [
      'id' => [
        'type' => 'serial',
        'unsigned' => TRUE,
        'not null' => TRUE,
        'description' => 'Primary Key: Unique news item ID.',
      ],
      'trend_id' => [
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
        'description' => 'Foreign key linking to google_trends_data.id.',
      ],
      'title' => [
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'default' => '',
        'description' => 'The news item title.',
      ],
      'snippet' => [
        'type' => 'text',
        'size' => 'normal',
        'not null' => FALSE,
        'description' => 'The news item snippet.',
      ],
      'url' => [
        'type' => 'varchar',
        'length' => 2048,
        'not null' => TRUE,
        'default' => '',
        'description' => 'The news item URL.',
      ],
      'source' => [
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'default' => '',
        'description' => 'The news item source (e.g., "New York Times").',
      ],
    ],
    'primary key' => ['id'],
    'indexes' => [
      'trend_id' => ['trend_id'],
    ],
    'foreign keys' => [
      'trend_item' => [
        'table' => 'google_trends_data',
        'columns' => ['trend_id' => 'id'],
      ],
    ],
  ];

  return $schema;
}

/**
 * Update traffic field from varchar to int and add processing_cost field.
 */
function google_trends_importer_update_9001() {
  $database = \Drupal::database();
  $schema = $database->schema();
  
  // Check if traffic is already an integer (fresh install)
  if ($schema->fieldExists('google_trends_data', 'traffic')) {
    $table_info = $database->query("DESCRIBE {google_trends_data} traffic")->fetch();
    
    // Only update if it's currently varchar/text
    if (strpos(strtolower($table_info->Type), 'int') === FALSE) {
      // Add temporary column
      $schema->addField('google_trends_data', 'traffic_int', [
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => FALSE,
        'description' => 'Temporary column for traffic conversion.',
      ]);
      
      // Convert existing data - extract numbers and handle K/M/B multipliers
      $database->query("
        UPDATE {google_trends_data} 
        SET traffic_int = CASE
          WHEN traffic LIKE '%M%' THEN CAST(REGEXP_REPLACE(traffic, '[^0-9.]', '') AS DECIMAL(10,2)) * 1000
          WHEN traffic LIKE '%B%' THEN CAST(REGEXP_REPLACE(traffic, '[^0-9.]', '') AS DECIMAL(10,2)) * 1000000
          ELSE CAST(REGEXP_REPLACE(traffic, '[^0-9.]', '') AS UNSIGNED)
        END
        WHERE traffic != ''
      ");
      
      // Drop old column
      $schema->dropField('google_trends_data', 'traffic');
      
      // Rename new column
      $schema->changeField('google_trends_data', 'traffic_int', 'traffic', [
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
        'default' => 0,
        'description' => 'Approximate traffic in thousands (e.g., 100 for 100K+ searches).',
      ]);
      
      // Add index on traffic
      if (!$schema->indexExists('google_trends_data', 'traffic')) {
        $schema->addIndex('google_trends_data', 'traffic', ['traffic'], [
          'fields' => [
            'traffic' => [
              'type' => 'int',
              'unsigned' => TRUE,
              'not null' => TRUE,
              'default' => 0,
            ],
          ],
        ]);
      }
    }
  }
  
  // Add processing_cost field if it doesn't exist
  if (!$schema->fieldExists('google_trends_data', 'processing_cost')) {
    $schema->addField('google_trends_data', 'processing_cost', [
      'type' => 'numeric',
      'precision' => 10,
      'scale' => 6,
      'not null' => FALSE,
      'description' => 'Cost in USD for processing this trend with OpenAI.',
    ]);
  }
  
  return t('Updated traffic field to integer and added processing_cost field.');
}